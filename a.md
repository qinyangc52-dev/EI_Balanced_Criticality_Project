这是一个基于 BrainPy 框架复现论文《Critical Avalanches in Excitation-Inhibition Balanced Networks Reconcile Response Reliability with Sensitivity for Optimal Neural Representation》的软件设计说明书。

本文档旨在提供一个严谨的、可追踪的开发指南。

---

# 软件设计说明书：兴奋-抑制平衡网络中的临界雪崩复现

**版本**：1.0
**目标框架**：BrainPy
**参考文献**：Yang, Z., Liang, J., & Zhou, C. (2025). *Physical Review Letters 134, 028401*.

---

## 1. 系统概述

本项目旨在构建一个生物物理合理的兴奋-抑制（E-I）平衡神经网络模型，通过调节抑制性突触的衰减时间常数（$\tau^d_I$），复现网络从亚临界状态到超临界状态的相变过程，并验证临界状态下的幂律雪崩分布特性。

### 开发阶段规划
*   **阶段一**：模型参数配置与数学定义
*   **阶段二**：网络结构与动力学实现
*   **阶段三**：模拟运行与数据采集
*   **阶段四**：雪崩分析算法实现

---

## 2. 阶段一：模型参数配置与数学定义

本阶段的目标是建立所有模型常数的单一事实来源（SSOT），确保所有数值严格对应论文描述。

### 2.1 网络拓扑参数
| 参数符号 | 参数值 | 描述 | 来源定位 (PDF) |
| :--- | :--- | :--- | :--- |
| $N$ | 1000 | 神经元总数 | 第7页 右栏 第2段 |
| $N_E$ | 800 (80%) | 兴奋性神经元数量 | 第7页 右栏 第2段 |
| $N_I$ | 200 (20%) | 抑制性神经元数量 | 第7页 右栏 第2段 |
| $p$ | 0.2 | 连接概率（随机连接） | 第7页 左栏 "Appendix A" 第1段 / 右栏 第2段 |

### 2.2 神经元动力学参数 (LIF模型)
对应方程：公式 (A1)
$$ \frac{dV_i}{dt} = \frac{1}{\tau_\alpha}(V_{rest} - V_i) + I_i^{rec} + I_i $$

| 参数符号 | 参数值 | 描述 | 来源定位 (PDF) |
| :--- | :--- | :--- | :--- |
| $V_{rest}$ | -60 mV | 静息电位 (复位电位) | 第7页 右栏 公式(A1)下方 |
| $V_{rev}^{leak}$ | -70 mV | 漏电流反转电位 | 第7页 右栏 公式(A1)下方 |
| $V_{th}$ | -50 mV | 发放阈值 | 第7页 右栏 第一段 (续) |
| $\tau_E$ | 20 ms | 兴奋性神经元膜时间常数 | 第7页 右栏 公式(A1)下方 |
| $\tau_I$ | 10 ms | 抑制性神经元膜时间常数 | 第7页 右栏 第一段 (续) |
| $t_{ref}^E$ | 2 ms | 兴奋性不应期 | 第7页 右栏 第一段 (续) |
| $t_{ref}^I$ | 1 ms | 抑制性不应期 | 第7页 右栏 第一段 (续) |

### 2.3 突触动力学参数
对应方程：公式 (A2, A3) - 双指数电导模型
$$ F_\beta = \frac{1}{\tau^d_\beta - \tau_r} (e^{-t/\tau^d_\beta} - e^{-t/\tau_r}) $$

| 参数符号 | 参数值 | 描述 | 来源定位 (PDF) |
| :--- | :--- | :--- | :--- |
| $V_{rev}^E$ | 0 mV | 兴奋性反转电位 (AMPA) | 第7页 右栏 公式(A2)下方 |
| $V_{rev}^I$ | -70 mV | 抑制性反转电位 (GABA) | 第7页 右栏 公式(A2)下方 |
| $\tau_r$ | 0.5 ms | 突触上升时间常数 | 第7页 右栏 公式(A3)下方 |
| $\tau^d_E$ | 2 ms | 兴奋性突触衰减时间 (AMPA) | 第7页 右栏 公式(A3)下方 |
| **$\tau^d_I$** | **2 - 11 ms** | **核心控制参数** (GABA) | 第7页 右栏 底部 (控制临界相变) |
| $g_{EE}$ | 0.012 | E -> E 突触权重 | 第7页 右栏 底部 |
| $g_{IE}$ | 0.024 | E -> I 突触权重 | 第7页 右栏 底部 |
| $g_{EI}$ | 0.18 | I -> E 突触权重 | 第7页 右栏 底部 (注：原文写为第二个$g_{IE}$，根据上下文和E-I平衡惯例修正为$g_{EI}$) |
| $g_{II}$ | 0.31 | I -> I 突触权重 | 第7页 右栏 底部 |

### 2.4 外部驱动参数
模型通过泊松背景噪声驱动。
$$ I_i \text{ represents background input... } N_o = p N_E $$

| 参数符号 | 参数值 | 描述 | 来源定位 (PDF) |
| :--- | :--- | :--- | :--- |
| $N_o$ | 160 | 每个神经元接收的外部输入源数量 ($0.2 \times 800$) | 第7页 右栏 底部 |
| $Q_o$ | 25 Hz | 外部输入频率 | 第8页 左栏 第一段 ($Q_o = 25$ Hz) |
| $g_{Eo}$ | 0.022 | 外部 -> E 耦合强度 | 第8页 左栏 第一段 |
| $g_{Io}$ | 0.04 | 外部 -> I 耦合强度 | 第8页 左栏 第一段 |

---

## 3. 阶段二：网络结构与动力学实现 (BrainPy设计)

本阶段将数学方程映射到 BrainPy 的类结构中。

### 3.1 神经元模型类 (NeuronGroup)
*   **基类选择**：`brainpy.dyn.LifRef`
*   **实现细节**：
    *   需要分别实例化 `group_E` 和 `group_I`，因为它们的 `tau` 和 `ref` 参数不同。
    *   **积分方式**：使用 Exponential Euler 或 RK4，步长建议 $dt=0.05$ ms (高精度要求)。
    *   **输入处理**：该模型是基于电导的 (Conductance-based)。BrainPy 的标准 LIF 接收电流输入。
    *   **关键转换**：需在突触层计算电流 $I_{syn}(t) = g(t)(V_{rev} - V_i(t))$，并将其作为 `input` 传入神经元。

### 3.2 突触投影类 (SynapticProjection)
*   **基类选择**：自定义类，继承自 `brainpy.dyn.Projection` 或 `brainpy.dyn.TwoEndConn`。
*   **动力学实现 (公式 A3)**：
    *   公式 A3 描述的是双指数滤波器。这等价于两个耦合的一阶微分方程。
    *   定义变量 `g` (电导) 和 `h` (辅助变量)。
    *   **微分方程组**：
        $$ \frac{dh}{dt} = -\frac{h}{\tau_r} + \sum \delta(t-t_k) $$
        $$ \frac{dg}{dt} = -\frac{g}{\tau^d} + h $$
    *   **归一化**：注意公式 A3 包含系数 $\frac{1}{\tau^d - \tau_r}$。在代码中，突触权重更新时应乘以该归一化因子，或者在计算电流时统一处理。
*   **连接矩阵**：使用 `brainpy.conn.FixedProb(prob=0.2)`。

### 3.3 网络组装 (NetworkAssembly)
需构建 6 个突触投影实例：
1.  Ext -> E (AMPA dynamics)
2.  Ext -> I (AMPA dynamics)
3.  E -> E (AMPA dynamics)
4.  E -> I (AMPA dynamics)
5.  I -> E (GABA dynamics, **$\tau^d_I$ 可变**)
6.  I -> I (GABA dynamics, **$\tau^d_I$ 可变**)

---

## 4. 阶段三：模拟运行与数据采集

### 4.1 模拟配置
*   **时间步长 ($dt$)**：0.05 ms (为了准确模拟 0.5ms 的 $\tau_{rise}$)。
*   **总时长 ($T$)**：建议至少 1000 ms - 5000 ms 以获取足够的统计数据。
*   **控制变量**：设置循环，分别运行以下三种情况：
    *   亚临界 (Subcritical): $\tau^d_I = 2$ ms
    *   临界 (Critical): $\tau^d_I = 8$ ms
    *   超临界 (Supercritical): $\tau^d_I = 11$ ms

### 4.2 监控器 (Monitors)
*   记录所有兴奋性神经元的脉冲发放时间：`group_E.spike`。
*   (可选) 记录部分神经元的膜电位 $V$ 以验证 sub-threshold 动力学。

---

## 5. 阶段四：雪崩分析算法实现

本阶段复现论文中关于“神经雪崩”的定义和统计方法。

### 5.1 数据预处理
*   **来源**：第8页 左栏 "Appendix B: Measurement..." 第二段。
*   **步骤**：
    1.  合并 `group_E` 中所有神经元的脉冲，得到群体脉冲序列 (Population Spike Train)。
    2.  计算群体平均脉冲间隔 $\langle ISI \rangle$。
    3.  **时间分箱 (Binning)**：设置时间窗口 $\Delta t = \langle ISI \rangle$。

### 5.2 雪崩定义
*   **来源**：第2页 正文 左栏 底部 / Appendix B。
*   **算法**：
    1.  将时间轴划分为宽度为 $\Delta t$ 的连续箱。
    2.  计算每个箱内的总脉冲数。
    3.  **雪崩开始**：一个非空箱（spikes > 0）。
    4.  **雪崩结束**：随后的第一个空箱（spikes = 0）。
    5.  **雪崩大小 (Size, $S$)**：雪崩持续期间所有箱内脉冲总和。
    6.  **雪崩时长 (Duration, $T$)**：雪崩跨越的箱的数量（或物理时间）。

### 5.3 统计验证 (输出交付物)
*   绘制 $P(S)$ 和 $P(T)$ 的概率分布图（双对数坐标）。
*   **预期结果**：
    *   $\tau^d_I = 2$ ms：指数分布（下垂）。
    *   $\tau^d_I = 8$ ms：幂律分布（直线），斜率接近 -1.5 (Size) 和 -2.0 (Duration)。
    *   $\tau^d_I = 11$ ms：双峰分布或尾部隆起（"Bimodal/Bump"），表示过同步。